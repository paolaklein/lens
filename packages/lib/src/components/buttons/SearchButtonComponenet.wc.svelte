<svelte:options
    customElement={{
        tag: "lens-search-button",
        props: {
            measures: { type: "Object" },
            disabled: { type: "Boolean" },
            backendConfig: { type: "Object" },
        },
    }}
/>

<script lang="ts">
    import { buildAstFromQuery } from "../../helpers/ast-transformer";
    import { queryModified, queryStore } from "../../stores/query";
    import { measureStore } from "../../stores/measures";
    import { translateAstToCql } from "../../cql-translator-service/ast-to-cql-translator";
    import { buildLibrary, buildMeasure } from "../../helpers/cql-measure";
    import { Spot } from "../../classes/spot";
    import {
        catalogueKeyToResponseKeyMap,
        uiSiteMappingsStore,
    } from "../../stores/mappings";
    import { responseStore } from "../../stores/response";
    import { lensOptions } from "../../stores/options";
    import type { BackendOptions, SpotOption } from "../../types/backend";

    export let title: string = "Search";

    export let disabled: boolean = false;

    $: options = $lensOptions?.backends as BackendOptions;

    let controller: AbortController;

    /**
     * watches the backendConfig for changes to populate the uiSiteMappingsStore with a map
     * web components' props are json, meaning that Maps are not supported
     * therefore it's a 2d array of strings which is converted to a map
     */
    $: uiSiteMappingsStore.update((mappings) => {
        options?.spots.forEach((spot) => {
            spot.uiSiteMap.forEach((site) => {
                mappings.set(site[0], site[1]);
            });
        });
        return mappings;
    });

    $: catalogueKeyToResponseKeyMap.update((mappings) => {
        options?.spots.forEach((spot) => {
            spot.catalogueKeyToResponseKeyMap.forEach((mapping) => {
                mappings.set(mapping[0], mapping[1]);
            });
        });
        return mappings;
    });

    /**
     * triggers a request to the backend via the spot class
     */
    const getResultsFromBackend = (): void => {
        /**
         * TODO emit event
         */

        if (controller) {
            controller.abort();
        }
        responseStore.set(new Map());

        controller = new AbortController();

        const ast = buildAstFromQuery($queryStore);

        options.spots.forEach((spot: SpotOption) => {
            /**
             * TODO: add backend measures
             */
            const cql = translateAstToCql(ast, false, "backend-measures");

            const library = buildLibrary(`${cql}`);
            const measure = buildMeasure(
                library.url,
                $measureStore.map((measureItem) => measureItem.measure),
            );
            const query = { lang: "cql", lib: library, measure: measure };

            const backend = new Spot(
                new URL(spot.url),
                spot.sites,
                responseStore,
            );
            console.log(backend);

            backend.send(btoa(decodeURI(JSON.stringify(query))), controller);
        });
        queryModified.set(false);
    };
</script>

<button
    part={`lens-search-button lens-search-button-${
        disabled ? "disabled" : "active"
    }`}
    on:click={getResultsFromBackend}
    {disabled}
>
    <div part="lens-search-button-magnifying-glass">&#x26B2;</div>
    <div part="lens-search-button-title">
        {title}
    </div>
</button>
